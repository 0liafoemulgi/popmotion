'use strict';

var utils = require('../inc/utils');
var each = utils.each;

/*
    Check all Actions for `onEnd`, return true if all are true

    @param [Actor]
    @param [boolean]
    @returns [boolean]
*/
var checkAllActionsHaveEnded = function (actor, hasChanged) {
    var hasEnded = true;
    var values = actor.state.values;

    each(actor.activeActions, function (key, action) {
        // Return if action has been deleted elsewhere
        if (!action) {
            return;
        }

        if (action.onFrame) {
            action.onFrame.call(actor, values, actor, action);
        }

        if (action.onUpdate && hasChanged) {
            action.onUpdate.call(actor, values, actor, action);
        }

        if (action.hasEnded && action.hasEnded(actor) === false) {
            hasEnded = false;
        } else {
            if (action.onComplete) {
                action.onComplete.call(actor, actor, action);
            }
            actor.unbindAction(key);
        }
    });

    return hasEnded;
};

module.exports = function (actor, framestamp) {
    if (actor.isActive) {
        actor.isActive = false;

        if (checkAllActionsHaveEnded(actor, actor.hasChanged)) {
            var numRoles = actor.roles.length;

            // Fire `complete` callbacks
            for (var i = 0; i < numRoles; i++) {
                var role = actor.roles[i];
                if (role.complete) {
                    role.complete.call(actor, actor);
                }
            }

            if (!actor.isActive) {
                actor.next();
            }
        } else {
            actor.isActive = true;
            actor.firstFrame = false;
        }
    }

    actor.framestamp = framestamp;
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9hY3Rvci9wb3N0LXJlbmRlci5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLElBQU0sUUFBUSxRQUFRLGNBQVIsQ0FBUjtBQUNOLElBQU0sT0FBTyxNQUFNLElBQU47Ozs7Ozs7OztBQVNiLElBQU0sMkJBQTJCLFVBQUMsS0FBRCxFQUFRLFVBQVIsRUFBdUI7QUFDcEQsUUFBSSxXQUFXLElBQVgsQ0FEZ0Q7QUFFcEQsUUFBSSxTQUFTLE1BQU0sS0FBTixDQUFZLE1BQVosQ0FGdUM7O0FBSXBELFNBQUssTUFBTSxhQUFOLEVBQXFCLFVBQUMsR0FBRCxFQUFNLE1BQU4sRUFBaUI7O0FBRXZDLFlBQUksQ0FBQyxNQUFELEVBQVM7QUFBRSxtQkFBRjtTQUFiOztBQUVBLFlBQUksT0FBTyxPQUFQLEVBQWdCO0FBQ2hCLG1CQUFPLE9BQVAsQ0FBZSxJQUFmLENBQW9CLEtBQXBCLEVBQTJCLE1BQTNCLEVBQW1DLEtBQW5DLEVBQTBDLE1BQTFDLEVBRGdCO1NBQXBCOztBQUlBLFlBQUksT0FBTyxRQUFQLElBQW1CLFVBQW5CLEVBQStCO0FBQy9CLG1CQUFPLFFBQVAsQ0FBZ0IsSUFBaEIsQ0FBcUIsS0FBckIsRUFBNEIsTUFBNUIsRUFBb0MsS0FBcEMsRUFBMkMsTUFBM0MsRUFEK0I7U0FBbkM7O0FBSUEsWUFBSSxPQUFPLFFBQVAsSUFBbUIsT0FBTyxRQUFQLENBQWdCLEtBQWhCLE1BQTJCLEtBQTNCLEVBQWtDO0FBQ3JELHVCQUFXLEtBQVgsQ0FEcUQ7U0FBekQsTUFFTztBQUNILGdCQUFJLE9BQU8sVUFBUCxFQUFtQjtBQUNuQix1QkFBTyxVQUFQLENBQWtCLElBQWxCLENBQXVCLEtBQXZCLEVBQThCLEtBQTlCLEVBQXFDLE1BQXJDLEVBRG1CO2FBQXZCO0FBR0Esa0JBQU0sWUFBTixDQUFtQixHQUFuQixFQUpHO1NBRlA7S0Fac0IsQ0FBMUIsQ0FKb0Q7O0FBMEJwRCxXQUFPLFFBQVAsQ0ExQm9EO0NBQXZCOztBQTZCakMsT0FBTyxPQUFQLEdBQWlCLFVBQUMsS0FBRCxFQUFRLFVBQVIsRUFBdUI7QUFDcEMsUUFBSSxNQUFNLFFBQU4sRUFBZ0I7QUFDaEIsY0FBTSxRQUFOLEdBQWlCLEtBQWpCLENBRGdCOztBQUdoQixZQUFJLHlCQUF5QixLQUF6QixFQUFnQyxNQUFNLFVBQU4sQ0FBcEMsRUFBdUQ7QUFDbkQsZ0JBQU0sV0FBVyxNQUFNLEtBQU4sQ0FBWSxNQUFaOzs7QUFEa0MsaUJBSTlDLElBQUksSUFBSSxDQUFKLEVBQU8sSUFBSSxRQUFKLEVBQWMsR0FBOUIsRUFBbUM7QUFDL0Isb0JBQUksT0FBTyxNQUFNLEtBQU4sQ0FBWSxDQUFaLENBQVAsQ0FEMkI7QUFFL0Isb0JBQUksS0FBSyxRQUFMLEVBQWU7QUFDZix5QkFBSyxRQUFMLENBQWMsSUFBZCxDQUFtQixLQUFuQixFQUEwQixLQUExQixFQURlO2lCQUFuQjthQUZKOztBQU9BLGdCQUFJLENBQUMsTUFBTSxRQUFOLEVBQWdCO0FBQ2pCLHNCQUFNLElBQU4sR0FEaUI7YUFBckI7U0FYSixNQWNPO0FBQ0gsa0JBQU0sUUFBTixHQUFpQixJQUFqQixDQURHO0FBRUgsa0JBQU0sVUFBTixHQUFtQixLQUFuQixDQUZHO1NBZFA7S0FISjs7QUF1QkEsVUFBTSxVQUFOLEdBQW1CLFVBQW5CLENBeEJvQztDQUF2QiIsImZpbGUiOiJwb3N0LXJlbmRlci5qcyIsInNvdXJjZXNDb250ZW50IjpbImNvbnN0IHV0aWxzID0gcmVxdWlyZSgnLi4vaW5jL3V0aWxzJyk7XG5jb25zdCBlYWNoID0gdXRpbHMuZWFjaDtcblxuLypcbiAgICBDaGVjayBhbGwgQWN0aW9ucyBmb3IgYG9uRW5kYCwgcmV0dXJuIHRydWUgaWYgYWxsIGFyZSB0cnVlXG5cbiAgICBAcGFyYW0gW0FjdG9yXVxuICAgIEBwYXJhbSBbYm9vbGVhbl1cbiAgICBAcmV0dXJucyBbYm9vbGVhbl1cbiovXG5jb25zdCBjaGVja0FsbEFjdGlvbnNIYXZlRW5kZWQgPSAoYWN0b3IsIGhhc0NoYW5nZWQpID0+IHtcbiAgICBsZXQgaGFzRW5kZWQgPSB0cnVlO1xuICAgIGxldCB2YWx1ZXMgPSBhY3Rvci5zdGF0ZS52YWx1ZXM7XG5cbiAgICBlYWNoKGFjdG9yLmFjdGl2ZUFjdGlvbnMsIChrZXksIGFjdGlvbikgPT4ge1xuICAgICAgICAvLyBSZXR1cm4gaWYgYWN0aW9uIGhhcyBiZWVuIGRlbGV0ZWQgZWxzZXdoZXJlXG4gICAgICAgIGlmICghYWN0aW9uKSB7IHJldHVybjsgfVxuXG4gICAgICAgIGlmIChhY3Rpb24ub25GcmFtZSkge1xuICAgICAgICAgICAgYWN0aW9uLm9uRnJhbWUuY2FsbChhY3RvciwgdmFsdWVzLCBhY3RvciwgYWN0aW9uKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChhY3Rpb24ub25VcGRhdGUgJiYgaGFzQ2hhbmdlZCkge1xuICAgICAgICAgICAgYWN0aW9uLm9uVXBkYXRlLmNhbGwoYWN0b3IsIHZhbHVlcywgYWN0b3IsIGFjdGlvbik7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoYWN0aW9uLmhhc0VuZGVkICYmIGFjdGlvbi5oYXNFbmRlZChhY3RvcikgPT09IGZhbHNlKSB7XG4gICAgICAgICAgICBoYXNFbmRlZCA9IGZhbHNlO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgaWYgKGFjdGlvbi5vbkNvbXBsZXRlKSB7XG4gICAgICAgICAgICAgICAgYWN0aW9uLm9uQ29tcGxldGUuY2FsbChhY3RvciwgYWN0b3IsIGFjdGlvbik7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBhY3Rvci51bmJpbmRBY3Rpb24oa2V5KTtcbiAgICAgICAgfVxuICAgIH0pO1xuXG4gICAgcmV0dXJuIGhhc0VuZGVkO1xufTtcblxubW9kdWxlLmV4cG9ydHMgPSAoYWN0b3IsIGZyYW1lc3RhbXApID0+IHtcbiAgICBpZiAoYWN0b3IuaXNBY3RpdmUpIHtcbiAgICAgICAgYWN0b3IuaXNBY3RpdmUgPSBmYWxzZTtcblxuICAgICAgICBpZiAoY2hlY2tBbGxBY3Rpb25zSGF2ZUVuZGVkKGFjdG9yLCBhY3Rvci5oYXNDaGFuZ2VkKSkge1xuICAgICAgICAgICAgY29uc3QgbnVtUm9sZXMgPSBhY3Rvci5yb2xlcy5sZW5ndGg7XG5cbiAgICAgICAgICAgIC8vIEZpcmUgYGNvbXBsZXRlYCBjYWxsYmFja3NcbiAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbnVtUm9sZXM7IGkrKykge1xuICAgICAgICAgICAgICAgIGxldCByb2xlID0gYWN0b3Iucm9sZXNbaV07XG4gICAgICAgICAgICAgICAgaWYgKHJvbGUuY29tcGxldGUpIHtcbiAgICAgICAgICAgICAgICAgICAgcm9sZS5jb21wbGV0ZS5jYWxsKGFjdG9yLCBhY3Rvcik7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAoIWFjdG9yLmlzQWN0aXZlKSB7XG4gICAgICAgICAgICAgICAgYWN0b3IubmV4dCgpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgYWN0b3IuaXNBY3RpdmUgPSB0cnVlO1xuICAgICAgICAgICAgYWN0b3IuZmlyc3RGcmFtZSA9IGZhbHNlO1xuICAgICAgICB9XG4gICAgfVxuICAgICAgICAgICAgXG4gICAgYWN0b3IuZnJhbWVzdGFtcCA9IGZyYW1lc3RhbXA7XG59OyJdfQ==